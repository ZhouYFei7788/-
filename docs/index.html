<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>风机风量测试工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; box-sizing: border-box; }
    h1 { text-align: center; font-size: 1.5em; margin-bottom: 10px; }
    .section { margin-bottom: 10px; }
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .inline-inputs {
      display: flex;
      flex-wrap: nowrap;
      gap: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
    }
    .inline-inputs label {
      display: inline-flex;
      align-items: center;
      font-size: 0.9em;
      white-space: nowrap;
    }
    .inline-inputs input {
      padding: 5px;
      font-size: 0.9em;
      width: 50px;
      box-sizing: border-box;
    }
    .design-input {
      margin-top: 5px;
    }
    .design-input label {
      font-size: 0.9em;
    }
    .design-input input {
      padding: 6px;
      font-size: 1em;
      width: 150px;
      box-sizing: border-box;
    }

    button { width: 48%; padding: 10px; font-size: 1em; margin: 1%; box-sizing: border-box; }
    .btn-generate { width: 98%; background-color: blue; color: white; margin: 1%; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
    th, td { border: 1px solid #000; padding: 5px; text-align: center; }
    .btn-calculate { background-color: green; color: white; }
    .btn-clear { background-color: red; color: white; }
    @media (max-width: 600px) {
      .grid-container { grid-template-columns: 1fr; }
      button { width: 100%; margin-bottom: 10px; }
      .inline-inputs { gap: 5px; }
      .inline-inputs input { width: 45px; padding: 3px; font-size: 0.8em; }
      h3 { font-size: 1em; margin: 5px 0; }
    }
  </style>
</head>
<body>
<h1>风机风量测试工具</h1>

<div class="section grid-container">
  <div><label>风口面积: <input type="number" id="area" step="0.01" value="2.24"></label></div>
  <div><label>允许偏差 (±%): <input type="number" id="tolerance" step="0.1" value="25"></label></div>
</div>

<div id="fan-speed-sections"></div>

<div class="section grid-container">
  <button class="btn-calculate" onclick="calculate()">计算</button>
  <button class="btn-clear" onclick="clearSpeedsOnly()">清除所有数据</button>
</div>

<div class="section">
  <button class="btn-generate" onclick="generateLowerSpeeds()">拟合100%档位生成数据</button>
</div>

<div class="section" id="result-section" style="display:none;">
  <table id="result-table">
    <thead>
      <tr>
        <th>档位</th>
        <th>平均风速</th>
        <th>实际风量</th>
        <th>设计风量</th>
        <th>偏差 (%)</th>
        <th>判定</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const levels = ["25%", "50%", "75%", "100%"];

  function createFanSpeedSections() {
    const container = document.getElementById('fan-speed-sections');
    levels.forEach(level => {
      let section = `<div class="section">
        <h3>${level} 转速档位</h3>
        <div class="inline-inputs">
          <label>点1: <input type="number" id="${level}-v1" step="0.01"></label>
          <label>点2: <input type="number" id="${level}-v2" step="0.01"></label>
          <label>点3: <input type="number" id="${level}-v3" step="0.01"></label>
          <label>点4: <input type="number" id="${level}-v4" step="0.01"></label>
          <label>点5: <input type="number" id="${level}-v5" step="0.01"></label>
        </div>
        <div class="design-input">
          <label>设计风量: <input type="number" id="${level}-design" step="1"></label>
        </div>
      </div>`;
      container.innerHTML += section;
    });
  }

  function generateLowerSpeeds() {
    const area = parseFloat(document.getElementById('area').value);
    const tolerance = parseFloat(document.getElementById('tolerance').value);
    let v100 = [];
    for (let i = 1; i <= 5; i++) {
      const v = parseFloat(document.getElementById(`100%-v${i}`).value);
      if (isNaN(v)) { alert("请先输入100%档位的5个点风速"); return; }
      v100.push(v);
    }
    const ratios = { "75%": 0.75, "50%": 0.5, "25%": 0.25 };
    Object.entries(ratios).forEach(([level, factor]) => {
      const designFlowInput = document.getElementById(`${level}-design`);
      const designFlow = parseFloat(designFlowInput?.value);
      if (isNaN(designFlow)) { console.warn(`未输入 ${level} 档的设计风量，跳过`); return; }
      const devPercent = (Math.random() * (tolerance - 5) + 5) / 100;
      const targetFlow = designFlow * (1 + devPercent);
      const targetAvg = targetFlow / (area * 3600);
      let disturbed = v100.map(v => {
        const scaled = v * factor;
        const disturbance = 1 + (Math.random() * 0.4 - 0.2);
        return scaled * disturbance;
      });
      const currentAvg = disturbed.reduce((a,b)=>a+b,0)/disturbed.length;
      const scale = targetAvg / currentAvg;
      const finalSpeeds = disturbed.map(v => parseFloat((v*scale).toFixed(2)));
      for (let i=1;i<=5;i++) {
        document.getElementById(`${level}-v${i}`).value = finalSpeeds[i-1];
      }
    });
  }

  function calculate() {
    const area = parseFloat(document.getElementById('area').value);
    const tolerance = parseFloat(document.getElementById('tolerance').value);
    const tbody = document.querySelector('#result-table tbody');
    tbody.innerHTML = "";
    levels.forEach(level => {
      const vArr = [];
      for (let i = 1; i <= 5; i++) {
        let v = parseFloat(document.getElementById(`${level}-v${i}`).value);
        if (isNaN(v)) { return; }
        // 保留两位小数再计算
        v = parseFloat(v.toFixed(2));
        vArr.push(v);
      }
      const designFlow = parseFloat(document.getElementById(`${level}-design`).value);
      if (isNaN(designFlow)) { return; }
      const avg = parseFloat((vArr.reduce((a,b)=>a+b,0)/vArr.length).toFixed(2));
      const actualFlow = parseFloat((avg * area * 3600).toFixed(2));
      const deviation = ((actualFlow - designFlow)/designFlow*100).toFixed(2);
      const isPass = Math.abs(deviation) <= tolerance ? '✅' : '❌';
      tbody.innerHTML += `<tr>
        <td>${level}</td>
        <td>${avg.toFixed(2)}</td>
        <td>${actualFlow.toFixed(2)}</td>
        <td>${designFlow.toFixed(2)}</td>
        <td>${deviation}</td>
        <td>${isPass}</td>
      </tr>`;
    });
    document.getElementById('result-section').style.display='block';
  }

  function clearSpeedsOnly() {
    levels.forEach(level => {
      for (let i=1;i<=5;i++) document.getElementById(`${level}-v${i}`).value='';
    });
    document.querySelector('#result-table tbody').innerHTML='';
    document.getElementById('result-section').style.display='none';
  }

  createFanSpeedSections();
</script>
</body>
</html>
